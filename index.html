<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Craic | Good Times & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #313338; color: #dbdee1; font-family: 'gg sans', 'Helvetica Neue', Helvetica, Arial, sans-serif; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; background-color: #2b2d31; }
        ::-webkit-scrollbar-thumb { background-color: #1a1b1e; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #2b2d31; }
        .server-icon { transition: all 0.2s; }
        .server-icon:hover { border-radius: 16px; background-color: #23a559; }
        .server-active { border-radius: 16px; background-color: #23a559; }
        .channel-item:hover { background-color: #35373c; color: #dbdee1; }
        .channel-active { background-color: #404249; color: white; }
        .tooltip { visibility: hidden; position: absolute; left: 80px; background: #111; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; z-index: 50; font-weight: bold; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.1s; pointer-events: none; }
        .group:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip::before { content: ""; position: absolute; top: 50%; right: 100%; margin-top: -5px; border-width: 5px; border-style: solid; border-color: transparent #111 transparent transparent; }
        .md-code { background-color: #2b2d31; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.85em; }
        .md-pre { background-color: #2b2d31; padding: 8px; border-radius: 4px; margin-top: 4px; font-family: monospace; overflow-x: auto; border: 1px solid #1e1f22; }
        .md-quote { border-left: 4px solid #4e5058; padding-left: 8px; color: #949ba4; margin: 4px 0; }
        .message-actions { opacity: 0; transition: opacity 0.1s; }
        .group:hover .message-actions { opacity: 1; }
        .mobile-sidebar { transition: transform 0.3s ease-in-out; }
        .mobile-open { transform: translateX(0) !important; }
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #23a559; border-radius: 50%; width: 14px; height: 14px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .reaction { background-color: #2b2d31; border-radius: 8px; padding: 2px 6px; font-size: 12px; cursor: pointer; display: flex; items-center; border: 1px solid transparent; transition: all 0.1s; user-select: none; }
        .reaction:hover { background-color: #35373c; border-color: #4e5058; }
        .reaction.active { background-color: rgba(35, 165, 89, 0.15); border-color: #23a559; }
        .reaction-picker { animation: popIn 0.1s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .typing-dots span { width: 6px; height: 6px; background-color: #dbdee1; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        audio { height: 32px; width: 250px; }
        .date-divider { display: flex; align-items: center; justify-content: center; margin: 24px 0; position: relative; }
        .date-divider::before { content: ""; height: 1px; background: #3f4147; position: absolute; left: 0; right: 0; z-index: 0; }
        .date-divider span { background: #313338; padding: 0 8px; color: #949ba4; font-size: 12px; font-weight: 600; z-index: 1; }
        .voice-avatar-speaking { box-shadow: 0 0 0 2px #23a559; border-color: transparent !important; }
        .voice-connected-bar { background-color: #232428; border-top: 1px solid #1f2023; padding: 8px 10px; }
    </style>
</head>
<body class="flex h-screen w-screen bg-[#313338]">

    <audio id="sound-msg" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>
    <audio id="sound-voice-join" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="sound-voice-leave" src="https://assets.mixkit.co/active_storage/sfx/2359/2359-preview.mp3"></audio>
    <input type="file" id="file-upload" class="hidden" accept="image/*">
    
    <div id="voice-streams" class="hidden"></div>

    <div id="generic-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-[#313338] w-full max-w-sm rounded-lg shadow-2xl p-6 transform scale-95 transition-transform duration-200" id="generic-modal-content">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-4">Title</h3>
            <p id="modal-desc" class="text-[#dbdee1] text-sm mb-4">Description</p>
            <input type="text" id="modal-input" class="w-full bg-[#1e1f22] text-white p-2 rounded outline-none focus:ring-2 focus:ring-[#23a559] mb-6 hidden">
            <div class="flex justify-end space-x-2">
                <button onclick="closeGenericModal()" class="px-4 py-2 text-white hover:underline text-sm">Cancel</button>
                <button id="modal-confirm-btn" class="bg-[#23a559] hover:bg-[#1b8045] text-white px-4 py-2 rounded text-sm font-medium transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <div id="user-popup" class="fixed z-50 hidden" style="width: 300px;">
        <div class="bg-[#232428] rounded-lg shadow-2xl overflow-hidden border border-[#1e1f22]">
            <div class="h-16 bg-[#23a559]"></div>
            <div class="px-4 pb-4 relative">
                <img id="popup-avatar" src="" class="w-20 h-20 rounded-full border-[6px] border-[#232428] absolute -top-10">
                <div class="mt-12">
                    <h3 id="popup-username" class="text-xl font-bold text-white"></h3>
                    <div class="border-t border-[#3f4147] my-3"></div>
                    <button onclick="startDM()" class="w-full bg-[#23a559] hover:bg-[#1b8045] text-white py-2 rounded text-sm font-medium transition-colors">Send Message</button>
                </div>
            </div>
        </div>
        <div class="fixed inset-0 -z-10" onclick="document.getElementById('user-popup').classList.add('hidden')"></div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-200">
        <div class="bg-[#313338] w-full max-w-md rounded-lg shadow-2xl transform scale-95 transition-transform duration-200 m-4" id="settings-content">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-6">User Settings</h2>
                <div class="flex justify-center mb-6">
                    <div class="relative group cursor-pointer">
                        <img id="settings-avatar-preview" src="" class="w-24 h-24 rounded-full border-4 border-[#1e1f22]">
                        <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-camera text-white"></i></div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-[#b5bac1] uppercase mb-2">Display Name</label><input type="text" id="settings-username" class="w-full bg-[#1e1f22] text-[#dbdee1] p-2.5 rounded border-none outline-none focus:ring-2 focus:ring-[#23a559]"></div>
                    <div><label class="block text-xs font-bold text-[#b5bac1] uppercase mb-2">Avatar URL</label><input type="text" id="settings-avatar-url" class="w-full bg-[#1e1f22] text-[#dbdee1] p-2.5 rounded border-none outline-none focus:ring-2 focus:ring-[#23a559]"></div>
                </div>
            </div>
            <div class="bg-[#2b2d31] p-4 rounded-b-lg flex justify-end space-x-3">
                <button onclick="closeSettings()" class="px-4 py-2 text-white hover:underline text-sm font-medium">Cancel</button>
                <button onclick="saveSettings()" class="bg-[#23a559] hover:bg-[#1b8045] text-white px-6 py-2 rounded text-sm font-medium transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

    <div id="sidebar-container" class="mobile-sidebar fixed inset-y-0 left-0 z-40 flex transform -translate-x-full md:relative md:translate-x-0 h-full">
        <nav class="w-[72px] bg-[#1e1f22] flex flex-col items-center py-3 overflow-y-auto space-y-2 no-scrollbar z-20 h-full" id="server-list">
            <div onclick="switchToHome()" class="group relative flex justify-center w-full cursor-pointer mb-2">
                <div id="pill-home" class="absolute left-0 top-3 h-2 w-1 bg-white rounded-r-full transition-all h-10"></div>
                <div id="icon-home" class="h-12 w-12 bg-[#23a559] rounded-[16px] flex items-center justify-center text-white server-icon transition-all"><i class="fa-solid fa-comments text-xl"></i></div>
            </div>
            <hr class="w-8 border-[#35363c] mx-auto rounded mb-2">
            <div id="dynamic-servers"></div>
            <div onclick="openCreateServerModal()" class="group relative flex justify-center w-full cursor-pointer mt-2">
                <div class="h-12 w-12 bg-[#313338] rounded-[24px] flex items-center justify-center text-[#23a559] hover:text-white server-icon transition-all"><i class="fa-solid fa-plus text-xl"></i></div>
                <span class="tooltip">Create Server</span>
            </div>
            <div onclick="openJoinServerModal()" class="group relative flex justify-center w-full cursor-pointer mt-2">
                <div class="h-12 w-12 bg-[#313338] rounded-[24px] flex items-center justify-center text-[#b5bac1] hover:text-white server-icon transition-all"><i class="fa-solid fa-compass text-xl"></i></div>
                <span class="tooltip">Join Server</span>
            </div>
        </nav>

        <aside class="w-60 bg-[#2b2d31] flex flex-col min-w-[240px] h-full" id="middle-sidebar">
            <header class="h-12 px-4 flex items-center justify-between shadow-sm border-b border-[#1f2023] hover:bg-[#35373c] cursor-pointer transition-colors" onclick="copyServerInvite()">
                <h1 class="font-bold text-[15px] truncate text-white" id="sidebar-header">Direct Messages</h1>
                <i class="fa-solid fa-chevron-down text-xs" id="header-icon"></i>
            </header>
            <div class="flex-1 overflow-y-auto pt-3 px-2 space-y-1" id="channel-list"></div>
            
            <div id="voice-connected-bar" class="hidden voice-connected-bar flex flex-col">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex flex-col">
                        <span class="text-[#23a559] text-xs font-bold flex items-center"><i class="fa-solid fa-signal mr-1"></i> Voice Connected</span>
                        <span id="voice-channel-name" class="text-[#949ba4] text-[11px] truncate w-24">General</span>
                    </div>
                    <div class="flex space-x-1">
                        <button onclick="disconnectVoice()" class="h-8 w-8 flex items-center justify-center rounded hover:bg-[#3f4147] text-[#ed4245] transition-colors"><i class="fa-solid fa-phone-slash"></i></button>
                    </div>
                </div>
                <div class="flex justify-between px-1">
                    <button id="btn-voice-mute" onclick="toggleVoiceMute()" class="text-[#dbdee1] hover:text-white text-xs bg-[#1e1f22] px-2 py-1 rounded w-[48%] flex justify-center items-center"><i class="fa-solid fa-microphone mr-1"></i> <span>Mute</span></button>
                    <button id="btn-voice-deafen" onclick="toggleVoiceDeafen()" class="text-[#dbdee1] hover:text-white text-xs bg-[#1e1f22] px-2 py-1 rounded w-[48%] flex justify-center items-center"><i class="fa-solid fa-headphones mr-1"></i> <span>Deafen</span></button>
                </div>
            </div>

            <div class="h-[52px] bg-[#232428] px-2 flex items-center justify-between flex-shrink-0">
                <div onclick="openSettings()" class="flex items-center p-1 hover:bg-[#3f4147] rounded cursor-pointer group select-none">
                    <div class="relative mr-2"><img id="user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=init" class="w-8 h-8 rounded-full bg-gray-600"><div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-[#23a559] rounded-full border-[2px] border-[#232428]"></div></div>
                    <div class="text-sm"><div class="font-bold text-white text-[13px] w-20 truncate" id="user-name">Loading...</div><div class="text-xs text-[#949ba4]">Online</div></div>
                </div>
                <div class="flex"><div onclick="openSettings()" class="h-8 w-8 flex items-center justify-center hover:bg-[#3f4147] rounded cursor-pointer"><i class="fa-solid fa-gear text-sm"></i></div></div>
            </div>
        </aside>
    </div>

    <main class="flex-1 flex flex-col min-w-0 bg-[#313338] h-full w-full">
        <header class="h-12 px-4 flex items-center shadow-sm border-b border-[#26272d] flex-shrink-0">
            <button onclick="toggleMobileMenu()" class="md:hidden mr-4 text-[#dbdee1]"><i class="fa-solid fa-bars text-xl"></i></button>
            <div class="text-[#80848e] mr-2 text-xl" id="chat-icon"><i class="fa-solid fa-at"></i></div>
            <h3 class="font-bold text-white mr-4 whitespace-nowrap overflow-hidden text-ellipsis" id="channel-header">Craic Bot</h3>
            <span class="hidden md:block text-[#949ba4] text-xs px-2 truncate border-l border-[#3f4147]" id="channel-topic">Direct Message</span>
        </header>
        <div id="messages-container" class="flex-1 overflow-y-auto px-4 pt-4 space-y-4 flex flex-col">
            <div class="mt-auto"></div>
        </div>
        <div class="px-4 pb-6 pt-2">
            <div id="typing-indicator" class="h-6 text-xs text-[#dbdee1] font-bold px-2 flex items-center opacity-0 transition-opacity">
                <div class="typing-dots mr-1"><span></span><span></span><span></span></div>
                <span id="typing-names">Someone is typing...</span>
            </div>
            <div class="bg-[#383a40] rounded-lg px-4 py-3 flex items-center relative transition-colors" id="input-container">
                <div onclick="document.getElementById('file-upload').click()" class="bg-[#b5bac1] rounded-full h-6 w-6 flex items-center justify-center mr-3 cursor-pointer hover:text-white text-[#383a40] flex-shrink-0"><i class="fa-solid fa-plus text-xs"></i></div>
                <input type="text" id="message-input" placeholder="Message @Craic Bot" class="bg-transparent text-[#dbdee1] flex-1 outline-none placeholder-[#949ba4]" autocomplete="off">
                <div onclick="toggleRecording()" id="mic-btn" class="text-[#b5bac1] hover:text-white cursor-pointer ml-3 flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-[#3f4147] transition-all"><i class="fa-solid fa-microphone"></i></div>
                <div id="upload-spinner" class="loader hidden ml-2"></div>
            </div>
        </div>
    </main>

    <aside class="w-60 bg-[#2b2d31] hidden lg:flex flex-col p-4 border-l border-[#26272d]">
        <h3 class="text-[#949ba4] text-xs font-bold uppercase mb-4 px-2">Online Members â€” <span id="member-count">0</span></h3>
        <div id="member-list"></div>
    </aside>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, where, doc, setDoc, deleteDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

        let firebaseConfig, APP_ID;
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            APP_ID = typeof __app_id !== 'undefined' ? __app_id : "craic-chat-public-v1";
        } else {
            firebaseConfig = {
               apiKey: "AIzaSyCNE-cWIo2Ofr0spW1czbtJMSXs2mcaVpY",
  authDomain: "craic-chat-50d71.firebaseapp.com",
  projectId: "craic-chat-50d71",
  storageBucket: "craic-chat-50d71.firebasestorage.app",
  messagingSenderId: "1054605077942",
  appId: "1:1054605077942:web:e44b8aa557c60e085ca517",
  measurementId: "G-50T5S1NKR4"
            };
            APP_ID = "craic-chat-public-v1";
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let storage; try { storage = getStorage(app); } catch(e) {}

        let currentUser = null;
        let activeServerId = null;
        let activeServerOwnerId = null;
        let activeChannelId = null;
        let servers = []; let channels = [];
        let isHome = true;
        let channelMembers = new Map();
        let openDMs = JSON.parse(localStorage.getItem('echo_dms') || '[]');
        let selectedUserForDM = null;
        let typingTimeout = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let lastMsgDate = null;
        
        let currentVoiceChannelId = null;
        let voiceParticipants = new Map(); 
        let localStream = null;
        let peerConnections = {}; 
        let voiceMuted = false;
        let voiceDeafened = false;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let onlineMembers = new Map();

        const sndMsg = document.getElementById('sound-msg');
        const sndVJoin = document.getElementById('sound-voice-join');
        const sndVLeave = document.getElementById('sound-voice-leave');
        
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
             signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
        } else { signInAnonymously(auth).catch(console.error); }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const savedName = localStorage.getItem('craic_username');
                if (!user.displayName && !savedName) {
                    const rand = Math.floor(Math.random() * 9999);
                    await updateProfile(user, { displayName: `User${rand}`, photoURL: `https://api.dicebear.com/7.x/avataaars/svg?seed=${rand}` });
                } else if (!user.displayName && savedName) await updateProfile(user, { displayName: savedName });
                currentUser = user;
                updateUserUI();
                initDataListeners();
                initVoiceStates(); 
                initPresenceHeartbeat();
                initVoiceSignaling();
                
                const urlParams = new URLSearchParams(window.location.search);
                const joinId = urlParams.get('join');
                if(joinId) { 
                    openGenericModal("Join Server", "Connect to community?", "", () => switchServer(joinId), true);
                    window.history.replaceState({}, document.title, window.location.pathname);
                } else if(isHome) switchToHome();
            }
        });

        function initPresenceHeartbeat() {
        window.openSettings = () => { document.getElementById('settings-username').value = currentUser.displayName; document.getElementById('settings-avatar-url').value = currentUser.photoURL; document.getElementById('settings-avatar-preview').src = currentUser.photoURL; document.getElementById('settings-modal').classList.remove('hidden'); setTimeout(()=>document.getElementById('settings-modal').classList.remove('opacity-0'), 10); }
        window.closeSettings = () => { document.getElementById('settings-modal').classList.add('opacity-0'); setTimeout(()=>document.getElementById('settings-modal').classList.add('hidden'), 200); }
        window.saveSettings = async () => { const name = document.getElementById('settings-username').value; const avatar = document.getElementById('settings-avatar-url').value; if(name) { await updateProfile(currentUser, { displayName: name, photoURL: avatar }); localStorage.setItem('craic_username', name); updateUserUI(); closeSettings(); } }
        const msgInput = document.getElementById('message-input');
        msgInput.addEventListener('keydown', async (e) => { sendTyping(); if (e.key === 'Enter' && e.target.value.trim() !== '') { const text = e.target.value; e.target.value = ''; await addDoc(collection(db,'artifacts',APP_ID,'public','data','messages'), { content: text, timestamp: Date.now(), channelId: activeChannelId, userId: currentUser.uid, username: currentUser.displayName, avatar: currentUser.photoURL }); } });

        // Expose to window for HTML onclick
        window.openGenericModal = openGenericModal;
        window.closeGenericModal = closeGenericModal;
        window.openCreateServerModal = openCreateServerModal;
        window.openJoinServerModal = openJoinServerModal;
        window.promptCreateChannel = promptCreateChannel;
        window.deleteChannel = deleteChannel;
        window.copyServerInvite = copyServerInvite;
        window.toggleRecording = toggleRecording;
        window.editMessage = editMessage;
        window.submitEdit = submitEdit;
        window.switchServer = switchServer;
        window.switchToHome = switchToHome;
        window.switchChannel = switchChannel;
        window.promptDeleteMessage = promptDeleteMessage;
        window.toggleMobileMenu = toggleMobileMenu;
        window.showUserPopup = showUserPopup;
        window.startDM = startDM;
        window.removeDM = removeDM;
        window.openSettings = openSettings;
        window.closeSettings = closeSettings;
        window.saveSettings = saveSettings;
        window.joinVoice = joinVoice;
        window.disconnectVoice = disconnectVoice;
        window.toggleVoiceMute = toggleVoiceMute;
        window.toggleVoiceDeafen = toggleVoiceDeafen;
        window.toggleReaction = toggleReaction;

    </script>
</body>
</html>
